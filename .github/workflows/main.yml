name: Update Jira Fix Versions from Tag

on:
  push:
    tags:
      - '*' 

jobs:
  update-jira:
    runs-on: ubuntu-latest

    env:
      VERSION_NAME_PREFIX: "adminweb - "  # 👈 改為你的專案前綴

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Update Jira Issues with Fix Version
        env:
          JIRA_BASE_URL: ${{ secrets.JIRA_BASE_URL }}
          JIRA_USER_EMAIL: ${{ secrets.JIRA_USER_EMAIL }}
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
        run: |
          TAG_NAME="${GITHUB_REF#refs/tags/}"
          FIX_VERSION="${VERSION_NAME_PREFIX}${TAG_NAME}"
          echo "🧷 Tag: $TAG_NAME"
          echo "🔖 Fix Version: $FIX_VERSION"

          COMMIT_MSG=$(git log -1 --pretty=%B)
          echo "📄 Commit message: $COMMIT_MSG"

          ISSUE_KEYS=$(echo "$COMMIT_MSG" | grep -oE '[A-Z]+-[0-9]+' | sort -u)

          if [ -z "$ISSUE_KEYS" ]; then
            echo "⚠️ No Jira issue keys found. Exiting."
            exit 0
          fi

          for ISSUE_KEY in $ISSUE_KEYS; do
            echo "🔧 Processing $ISSUE_KEY"
            PROJECT_KEY="${ISSUE_KEY%%-*}"

            # 嘗試建立版本（ignore fail）
            curl -s -u "$JIRA_USER_EMAIL:$JIRA_API_TOKEN" \
              -X POST \
              -H "Content-Type: application/json" \
              --data "{\"name\":\"$FIX_VERSION\",\"project\":\"$PROJECT_KEY\"}" \
              "$JIRA_BASE_URL/rest/api/3/version" > /dev/null

            # 取得原本的 fixVersions
            CURRENT_FIX_VERSIONS=$(curl -s -u "$JIRA_USER_EMAIL:$JIRA_API_TOKEN" \
              -X GET \
              -H "Content-Type: application/json" \
              "$JIRA_BASE_URL/rest/api/3/issue/$ISSUE_KEY?fields=fixVersions" \
              | jq -r '.fields.fixVersions[].name')

            # 過濾掉相同 prefix 的舊版本
            CLEANED_VERSIONS=$(echo "$CURRENT_FIX_VERSIONS" | grep -v "^$VERSION_NAME_PREFIX" || true)

            # 加入新的版本
            FINAL_VERSIONS=$(echo -e "$CLEANED_VERSIONS\n$FIX_VERSION" | sort -u | jq -R -s -c 'split("\n") | map(select(length > 0)) | map({name: .})')

            echo "📦 Final fixVersions to set: $FINAL_VERSIONS"

            # 寫入 Jira
            curl -s -u "$JIRA_USER_EMAIL:$JIRA_API_TOKEN" \
              -X PUT \
              -H "Content-Type: application/json" \
              --data "{\"fields\": {\"fixVersions\": $FINAL_VERSIONS}}" \
              "$JIRA_BASE_URL/rest/api/3/issue/$ISSUE_KEY"

            echo "✅ Updated $ISSUE_KEY"
          done
