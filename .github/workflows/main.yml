name: Update Jira Fix Versions from Tag

on:
  push:
    tags:
      - '*'  # æ‰€æœ‰ tag éƒ½æœƒè§¸ç™¼

jobs:
  update-jira:
    runs-on: ubuntu-latest

    env:
      VERSION_NAME_PREFIX: "adminweb - "  # â† å°ˆæ¡ˆåç¨±

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Update Jira Issues with Fix Version
        env:
          JIRA_BASE_URL: ${{ secrets.JIRA_BASE_URL }}
          JIRA_USER_EMAIL: ${{ secrets.JIRA_USER_EMAIL }}
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
        run: |
          TAG_NAME="${GITHUB_REF#refs/tags/}"
          FIX_VERSION="${VERSION_NAME_PREFIX}${TAG_NAME}"
          echo "ðŸ§· Tag: $TAG_NAME"
          echo "ðŸ”– Fix Version: $FIX_VERSION"

          # å–å¾— commit message
          COMMIT_MSG=$(git log -1 --pretty=%B)
          echo "ðŸ“„ Commit message: $COMMIT_MSG"

          # æŠ“ Jira issue keyï¼Œä¾‹å¦‚ TEST-123
          ISSUE_KEYS=$(echo "$COMMIT_MSG" | grep -oE '[A-Z]+-[0-9]+' | sort -u)

          if [ -z "$ISSUE_KEYS" ]; then
            echo "âš ï¸ No Jira issue keys found. Exiting."
            exit 0
          fi

          for ISSUE_KEY in $ISSUE_KEYS; do
            echo "ðŸ”§ Updating $ISSUE_KEY"

            PROJECT_KEY="${ISSUE_KEY%%-*}"

            # å…ˆå»ºç«‹ç‰ˆæœ¬ï¼ˆå¿½ç•¥éŒ¯èª¤ï¼‰
            curl -s -u "$JIRA_USER_EMAIL:$JIRA_API_TOKEN" \
              -X POST \
              -H "Content-Type: application/json" \
              --data "{\"name\":\"$FIX_VERSION\",\"project\":\"$PROJECT_KEY\"}" \
              "$JIRA_BASE_URL/rest/api/3/version" > /dev/null

            # å–å¾—ç›®å‰ issue çš„ fixVersions
            CURRENT_FIX_VERSIONS=$(curl -s -u "$JIRA_USER_EMAIL:$JIRA_API_TOKEN" \
              -X GET \
              -H "Content-Type: application/json" \
              "$JIRA_BASE_URL/rest/api/3/issue/$ISSUE_KEY?fields=fixVersions" \
              | jq -r '.fields.fixVersions[].name')

            # çµ„åˆæ–°çš„ç‰ˆæœ¬åˆ—è¡¨ï¼ˆä¿ç•™åŽŸæœ‰ç‰ˆæœ¬ï¼ŒåŠ ä¸Šæ–°çš„ï¼‰
            ALL_VERSIONS=$(echo -e "$CURRENT_FIX_VERSIONS\n$FIX_VERSION" | sort -u | jq -R -s -c 'split("\n") | map(select(length > 0)) | map({name: .})')

            echo "ðŸ“¦ All fixVersions to set: $ALL_VERSIONS"

            # æ›´æ–° Jira issue
            curl -s -u "$JIRA_USER_EMAIL:$JIRA_API_TOKEN" \
              -X PUT \
              -H "Content-Type: application/json" \
              --data "{\"fields\": {\"fixVersions\": $ALL_VERSIONS}}" \
              "$JIRA_BASE_URL/rest/api/3/issue/$ISSUE_KEY"

            echo "âœ… Updated $ISSUE_KEY"
          done
